<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Workstation Migration | DavidS’ log</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Workstation Migration" />
<meta name="author" content="David Schmitt" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Since 1999, I’ve managed to migrate my Debian GNU/Linux workstation across hardware generations. The new machine is a tricked out Lenovo W540 with a really nice 2880x1620 IPS panel, a SSD and 16G RAM. A really nice machine. This time the task was a bit more complex than usual, as I chose to inflict multiple complexities upon myself:" />
<meta property="og:description" content="Since 1999, I’ve managed to migrate my Debian GNU/Linux workstation across hardware generations. The new machine is a tricked out Lenovo W540 with a really nice 2880x1620 IPS panel, a SSD and 16G RAM. A really nice machine. This time the task was a bit more complex than usual, as I chose to inflict multiple complexities upon myself:" />
<link rel="canonical" href="https://club.black.co.at/log/posts/2014-11-14-workstation-migration/" />
<meta property="og:url" content="https://club.black.co.at/log/posts/2014-11-14-workstation-migration/" />
<meta property="og:site_name" content="DavidS’ log" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-11-14T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Workstation Migration" />
<meta name="twitter:site" content="@dev_el_ops" />
<meta name="twitter:creator" content="@dev_el_ops" />
<script type="application/ld+json">
{"description":"Since 1999, I’ve managed to migrate my Debian GNU/Linux workstation across hardware generations. The new machine is a tricked out Lenovo W540 with a really nice 2880x1620 IPS panel, a SSD and 16G RAM. A really nice machine. This time the task was a bit more complex than usual, as I chose to inflict multiple complexities upon myself:","headline":"Workstation Migration","dateModified":"2014-11-14T00:00:00+00:00","datePublished":"2014-11-14T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://club.black.co.at/log/posts/2014-11-14-workstation-migration/"},"url":"https://club.black.co.at/log/posts/2014-11-14-workstation-migration/","author":{"@type":"Person","name":"David Schmitt"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/log/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://club.black.co.at/log/feed.xml" title="DavidS' log" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-155086367-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/log/">DavidS&#39; log</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/log/cv/index.html">DavidS&#39; CV</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Workstation Migration</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2014-11-14T00:00:00+00:00" itemprop="datePublished">Nov 14, 2014
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Since 1999, I’ve managed to migrate my <a href="http://www.debian.org">Debian
GNU/Linux</a> workstation across hardware generations.  The
new machine is a tricked out <a href="http://shop.lenovo.com/at/de/laptops/thinkpad/w-series/w540/">Lenovo
W540</a> with a
really nice 2880x1620 IPS panel, a SSD and 16G RAM. A really nice machine.
This time the task was a bit more complex than usual, as I chose to inflict
multiple complexities upon myself:</p>

<ul>
  <li>BIOS -&gt; UEFI</li>
  <li>
    <p>ext4 -&gt; btrfs migration</p>
  </li>
  <li>desktop -&gt; laptop</li>
  <li>nvidia only -&gt; bumblebee/optimus</li>
  <li>
    <p>200dpi screen</p>
  </li>
  <li>systemd</li>
</ul>

<p>Here is my tale.</p>

<h1 id="bios-partitioning-and-filesystem-the-transfer">BIOS, partitioning and filesystem: the transfer</h1>

<p>I did a test installation of Debian testing on the new machine to check out
what works and what doesn’t. UEFI support worked really well and provided a
branded entry to boot debian from the UEFI menu. Also this prepared the SSD
with proper partitions.</p>

<p>I’ve wanted to try out
<a href="https://btrfs.wiki.kernel.org/index.php/Main_Page">btrfs</a> for quite a while
now and the time seemd ripe. I did the test installation already to a btrfs
volume and that worked fine.</p>

<p>On the downside all tohse changes meant that I could not just <code class="language-plaintext highlighter-rouge">dd</code> over the
whole disk and be done, but needed a file-level solution. After some fiddling
and false-starts, I settled on booting the laptop into the
<a href="http://cdimage.debian.org/cdimage/weekly-builds/">debian-installer</a> (netinst,
teesting) rescue mode and the old desktop with the current <a href="http://grml.org/download/prerelease/">grml
2014.10-rc1</a>. The d-i on the target was
able to start a shell in the target system that was able to run update-grub
successfully after the transfer to fixup the grub config. Grml on the desktop
is just really nice to have a quick sshd running while having no traffic on the
source partition.</p>

<p>Transferring the actual data was accomplished by running</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rsync -avx --delete --numeric-ids root@DESKTOP:/mnt/ /
</code></pre></div></div>

<p>from the d-i chroot shell. The source partition was mounted on /mnt in the
grml.</p>

<p>After the transfer, <code class="language-plaintext highlighter-rouge">/etc/fstab</code> needs fixing to have the right device name and
fstype specified for root. Debian’s default of using UUIDs doesn’t help much,
when transplanting onto different partitions.</p>

<p>From the test installation the target had already an UEFI partition with
installed grub loader. The source system was lacking the actual binaries to
finish booting the system. Confusingly, the grub-efi-amd64-bin package delivers
the loader mods to /usr/lib/grub/x86_64-efi, while the booting grub expects
them in /boot/grub/x86_64-efi. The test installation had them there, so I
assume that there is some process I missed, which installs the on demand. I did
so manually to good effect. I totally exepct this to break in a few years when
a incomatible grub updates comes along and finds that I forgot to update some
weird config file.</p>

<p>I ran</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-grub
update-initramfs -k all -u
</code></pre></div></div>

<p>to get all the fancy new stuff to boot.</p>

<h1 id="the-system">The System</h1>

<p>Now that the system boots, I quickly noticed two things: I had reused the MAC
adress of the virtualisation bridge I had configured and X didn’t work.</p>

<p>Thanks to the detailled notes for <a href="https://gist.github.com/fbrozovic/9102118">running Debian on a
W540</a>, getting X to run was quite
easy: I installed the bumblebee and primus utilities, killed the old nvidia
<code class="language-plaintext highlighter-rouge">xorg.conf</code> and off it went.</p>

<p>The problem with the re-used MAC adress is not really a problem as the old
system will be re-purposed for a different project, which will include a fresh
install anyways. But I wanted to get to the gorund of this, as I was not aware
of this MAC adress persiting thingy. Turns out that systemd-networkd, which I
used to configure this bridge, computes a “static” MAC adress from
<code class="language-plaintext highlighter-rouge">/etc/machine-id</code> and the interface’s name. Resetting the machine id requires
the following steps:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /var/lib/dbus/machine-id /etc/machine-id
dbus-uuidgen --ensure
systemd-machine-id-setup
</code></pre></div></div>

<p>and a reboot.</p>

<h1 id="200dpi">200dpi</h1>

<p>The new screen is absolutely gorgeous. As <a href="http://lwn.net/Articles/619784/">LWN
reports</a> high dpi support on the desktop is
spotty. I use the i3wm as desktop environment and the 2880px horizontal space
mean, that I can now have two 1024+px windows side-by-side, which is really
nice as those pesky repsonsive design webpages now do not reformat. On the
downside, the text is quite small, so while it is good, it’s not as good as I
expected. Iceweasel and icedove have a weird multiple-personalities disorder:
icons and content seem to be rendered in pixels, while UI-text is rendered dpi
independently. I guess I’ll find some tweak somewhere to improve that, but for
today I’ve fiddled with this enough, and I’ll live through a bit of ugliness.</p>

  </div><a class="u-url" href="/log/posts/2014-11-14-workstation-migration/index.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/log/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">DavidS&#39; log</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">David Schmitt</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
