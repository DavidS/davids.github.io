<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Migrating to puppet future parser | DavidS’ log</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Migrating to puppet future parser" />
<meta name="author" content="David Schmitt" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The future parser in puppet is the compatibility shim to use before moving to Puppet 4.0, whose release is imminent. The future parser in 3.7 allows us to run the stable version with the parser of the new version, making manifests and modules ready for a seamless upgrade. Here I’ll describe the steps I needded to make this move." />
<meta property="og:description" content="The future parser in puppet is the compatibility shim to use before moving to Puppet 4.0, whose release is imminent. The future parser in 3.7 allows us to run the stable version with the parser of the new version, making manifests and modules ready for a seamless upgrade. Here I’ll describe the steps I needded to make this move." />
<link rel="canonical" href="https://club.black.co.at/log/posts/2015-02-04-puppet-future-parser/" />
<meta property="og:url" content="https://club.black.co.at/log/posts/2015-02-04-puppet-future-parser/" />
<meta property="og:site_name" content="DavidS’ log" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-02-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Migrating to puppet future parser" />
<meta name="twitter:site" content="@dev_el_ops" />
<meta name="twitter:creator" content="@dev_el_ops" />
<script type="application/ld+json">
{"description":"The future parser in puppet is the compatibility shim to use before moving to Puppet 4.0, whose release is imminent. The future parser in 3.7 allows us to run the stable version with the parser of the new version, making manifests and modules ready for a seamless upgrade. Here I’ll describe the steps I needded to make this move.","@type":"BlogPosting","headline":"Migrating to puppet future parser","dateModified":"2015-02-04T00:00:00+00:00","url":"https://club.black.co.at/log/posts/2015-02-04-puppet-future-parser/","datePublished":"2015-02-04T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://club.black.co.at/log/posts/2015-02-04-puppet-future-parser/"},"author":{"@type":"Person","name":"David Schmitt"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/log/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://club.black.co.at/log/feed.xml" title="DavidS' log" /><script async defer data-domain="club.black.co.at" src="https://plausible.black.co.at/js/plausible.js"></script>
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-155086367-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/log/">DavidS&#39; log</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/log/cv/index.html">DavidS&#39; CV</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Migrating to puppet future parser</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2015-02-04T00:00:00+00:00" itemprop="datePublished">Feb 4, 2015
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The <a href="https://docs.puppetlabs.com/puppet/latest/reference/experiments_future.html">future
parser</a>
in <a href="https://puppetlabs.com/">puppet</a> is the compatibility shim to use before
moving to Puppet 4.0, whose release is imminent. The future parser in 3.7
allows us to run the stable version with the parser of the new version, making
manifests and modules ready for a seamless upgrade. Here I’ll describe the
steps I needded to make this move.</p>

<h1 id="goal">Goal</h1>

<p>To make the transition possible and easy, I’ve two goals. first, I want to make
sure that I change as little as possible. This avoids trying too much in a
single pass of the codebase, which helps general stability. Secondly, the code
needs to run on both the old and the new parser to avoid having a flag day
across all people using the example42 modules.</p>

<h1 id="preparation">Preparation</h1>

<p>First I’ve upgraded to the most recent stable puppet version (3.7.4). This
ensure that I have a up-to-date iteration of the future parser, and I’m
developing against the state of the art.</p>

<p>Then I’ve created a new puppet.conf to use while testing. This way I can leave
the rest of my system running without impact while hacking on the future
branch. More sensible people would use vagrant, but being my own
biggest customer in this prod environment makes things easier.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- /etc/puppet/puppet.conf 2015-02-04 12:45:02.000000000 +0100
+++ /etc/puppet/future.conf 2015-02-04 12:45:16.000000000 +0100
@@ -32,21 +32,17 @@
   listen = false
   runinterval = 1800
   localconfig = $vardir/localconfig
-  environment = production
+  environment = future
+  masterport = 8888
+  noop = true

 [master]
   bindaddress = 0.0.0.0
   autosign = false

-  environment = production
-  manifest    = /srv/puppet/configuration/manifests/site.pp
-  modulepath  = /srv/puppet/configuration/modules
-  manifestdir=/srv/puppet/configuration/manifests
+  masterport = 8888
+  pidfile = /var/run/puppet/future.pid
+  parser = future
+  environment = future
+  environmentpath = /srv/puppet/environments
</code></pre></div></div>

<p>Commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puppet master --no-daemonize --verbose --config=/etc/puppet/future.conf
puppet agent --test --config=/etc/puppet/future.conf --noop
</code></pre></div></div>

<p>I hadn’t enabled <a href="https://docs.puppetlabs.com/puppet/latest/reference/environments_configuring.html">directory
environments</a>
and <a href="https://docs.puppetlabs.com/puppet/latest/reference/dirs_manifest.html#directory-behavior-vs-single-file">manifest
directory</a>,
so you see that there too. They are required to get access to a more nuanced
deployment workflow, caching and getting rid of “import”, which helps the
autoloader to actually notice that things have changed.</p>

<h1 id="puppet-changes">Puppet changes</h1>

<p>After those preparations, puppet now can tell me what I’m doing wrong, let’s get to the various things to fix:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Error: This 'if' statement is not productive. A non productive construct may only be placed last in a block/sequence</code></li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Error: Evaluation Error: Use of 'import' has been discontinued in favor of a manifest directory.</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Error: Evaluation Error: No matching entry for selector parameter with value '6'</code>: this one is nasty. Here’s the code:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Cope with Debian's folies
$debian_isc_era = $::operatingsystem ? {
  /(?i:Ubuntu)/ =&gt; $::lsbmajdistrelease ? {
    8       =&gt; '5',
    9       =&gt; '5',
    default =&gt; '6',
  },
  /(?i:Debian)/ =&gt; $::lsbmajdistrelease ? {
    5       =&gt; '5',
    default =&gt; '6',
  },
  default   =&gt; '6',
}

### Application related parameters

$package = $::operatingsystem ? {
  /(?i:Debian|Ubuntu|Mint)/ =&gt; $debian_isc_era ? {
    5 =&gt; 'dhcp3-server',
    6 =&gt; 'isc-dhcp-server',   # &lt;&lt;&lt;&lt;&lt;  Error HERE
  },
  /(?i:SLES|OpenSuSE)/      =&gt; 'dhcp-server',
  default                   =&gt; 'dhcp',
}
</code></pre></div>    </div>

    <p>The error is flagged on the marked line with “Error HERE”, luckily, because
this selector has no default case. What happens, is that facter delivers
<code class="language-plaintext highlighter-rouge">$::lsbmajdistrelease</code> as a string and the <code class="language-plaintext highlighter-rouge">? { 5 =&gt;</code> is not matching <code class="language-plaintext highlighter-rouge">"5"</code>
as it is a different type. The first selectors all have default statements
that fall through to the default label due to the mismatch.</p>

    <p>The recommended solution is to use <code class="language-plaintext highlighter-rouge">scanf</code> to type-convert safely.</p>
  </li>
</ul>

<h1 id="intermission">Intermission</h1>

<p>Using <code class="language-plaintext highlighter-rouge">scanf</code> brings several problems. First, it is only available in the
future parser. Secondly, there is no good way to find all instances where the
stricter interpretation will cause mismatches.</p>

<p>To actually prepare for a safe and regression-free migration, I’ve also
upgraded travis files to actually test against the future parser.</p>

<p>Or, at least, tried to. The module I was working on proved to be of the older
sort and testing <a href="https://twitter.com/garethr">@garethr</a>’s
<a href="https://github.com/garethr/puppet-module-skeleton">puppet-module-skeleton</a>
<a href="https://travis-ci.org/DavidS/puppet-scanf/builds/49461609">didn’t really work
out</a> either.</p>

<h1 id="acknowledgements">Acknowledgements</h1>

<p>This post was written at the <a href="http://cfgmgmtcamp.eu/puppet.html">Puppet Contributor Summit Gent
2015</a>, graciously sponsored by Puppetlabs.</p>

  </div><a class="u-url" href="/log/posts/2015-02-04-puppet-future-parser/index.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/log/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">DavidS&#39; log</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">David Schmitt</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
