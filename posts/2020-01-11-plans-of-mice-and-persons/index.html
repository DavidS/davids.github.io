<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Jekyll Gallery Hosting pt3: The best laid plans, of mice and persons … | DavidS’ log</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Jekyll Gallery Hosting pt3: The best laid plans, of mice and persons …" />
<meta name="author" content="David Schmitt" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Following up on last week’s post, today I’m gonna talk about the latest insights, hurdles and developments." />
<meta property="og:description" content="Following up on last week’s post, today I’m gonna talk about the latest insights, hurdles and developments." />
<link rel="canonical" href="https://club.black.co.at/log/posts/2020-01-11-plans-of-mice-and-persons/" />
<meta property="og:url" content="https://club.black.co.at/log/posts/2020-01-11-plans-of-mice-and-persons/" />
<meta property="og:site_name" content="DavidS’ log" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Jekyll Gallery Hosting pt3: The best laid plans, of mice and persons …" />
<meta name="twitter:site" content="@dev_el_ops" />
<meta name="twitter:creator" content="@dev_el_ops" />
<script type="application/ld+json">
{"description":"Following up on last week’s post, today I’m gonna talk about the latest insights, hurdles and developments.","headline":"Jekyll Gallery Hosting pt3: The best laid plans, of mice and persons …","dateModified":"2020-01-11T00:00:00+00:00","datePublished":"2020-01-11T00:00:00+00:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://club.black.co.at/log/posts/2020-01-11-plans-of-mice-and-persons/"},"url":"https://club.black.co.at/log/posts/2020-01-11-plans-of-mice-and-persons/","author":{"@type":"Person","name":"David Schmitt"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/log/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://club.black.co.at/log/feed.xml" title="DavidS' log" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-155086367-1', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', true);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/log/">DavidS&#39; log</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/log/cv/index.html">DavidS&#39; CV</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Jekyll Gallery Hosting pt3: The best laid plans, of mice and persons ...</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-01-11T00:00:00+00:00" itemprop="datePublished">Jan 11, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Following up on <a href="../2020-01-05-detailed-plans">last week’s post</a>, today I’m gonna talk about the latest insights, hurdles and developments.</p>

<h1 id="current-status">Current Status</h1>

<p>Last week I left off after getting some basic rendering working and linking up the newly generated <code class="language-plaintext highlighter-rouge">GalleryPage</code> instances into the jekyll <code class="language-plaintext highlighter-rouge">site</code>. After posting the write-up I did investigate a bit further, as I was having troubles getting the paths between the source and destination sorted out. Eventually I found that jekyll has a separate <a href="https://github.com/jekyll/jekyll/blob/654d3810395f2247a699b3aa3f828bc6d1ef30f6/lib/jekyll/document.rb"><code class="language-plaintext highlighter-rouge">Document</code></a> class that takes care of entries in <a href="https://jekyllrb.com/docs/collections/">collections</a>, which does handle path handling when the source is a underscore-directory, but duplicates/re-implements a lot of the remaining functionality, but differently.</p>

<p>To stay as close as possible to the original plan, I’ll substitute and <code class="language-plaintext highlighter-rouge">Page</code> for <code class="language-plaintext highlighter-rouge">Document</code> and see whether that fixes the path-translation issues I’ve been encountering when building the site. If that doesn’t work out, I’ll have to go back and modify the design and workflow of the generator. Maybe putting the entire <code class="language-plaintext highlighter-rouge">_galleries</code> folder content instead directly into the site and only go back and patch-up already instantiated <code class="language-plaintext highlighter-rouge">Pages</code> also works? This might even give more flexibility in the long-run, as any layout/page could access the new data for any images in that page/tree. Decision anxiety is a thing :-(, I’ve been on-and-off mulling over this for the last few days and both approaches have their merit. I’ll need to build (at least some of) both to test my assumptions.</p>

<h1 id="progress">Progress</h1>

<p>I’ll start with replacing the <code class="language-plaintext highlighter-rouge">Page</code>s with <code class="language-plaintext highlighter-rouge">Document</code>s. This seems to be the smaller operation and will give me a better understanding of the feasibility of this and what else is there in <code class="language-plaintext highlighter-rouge">Document</code>.</p>

<p><a href="https://jekyllrb.com/docs/collections/">Collections</a> are configured by adding an entry in the <code class="language-plaintext highlighter-rouge">_config.yml</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>collections:
  - galleries
</code></pre></div></div>

<p>doing so already creates an instance of <code class="language-plaintext highlighter-rouge">Jekyll::Collection</code> in <code class="language-plaintext highlighter-rouge">site.collections['galleries']</code> that has entries for every file in the directory tree:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[7] pry(#&lt;Jekyll::Collection&gt;):1&gt; entries
=&gt; [".",
 "first",
 "first/.",
 "first/Halloween13-39.jpg",
 "first/2012-07-29-Eingeschlafen.jpg",
 "first/index.html",
 "second",
 "second/.",
 "second/Frostig-001.jpg",
 "second/Frostig-003.jpg",
 "second/third",
 "second/third/.",
 "second/third/Morgenspaziergang-2.jpg",
 "second/third/Morgenspaziergang-3.jpg"]
[8] pry(#&lt;Jekyll::Collection&gt;):1&gt;
</code></pre></div></div>

<p>but there is no rendering of anything happening, as the documentation helpfully points out. To change that we need to set <code class="language-plaintext highlighter-rouge">output: true</code> on the collection:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>collections:
  galleries:
    output: true
</code></pre></div></div>

<p>and lo and behold, the index is rendered without any functionality in the cheesy-generator:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>david@zion:~/Projects/cheesy-gallery/spec/fixtures/test_site$ cat _galleries/first/index.html
---
x_layout: gallery
title: "The first Gallery"
---
This is a test gallery. The first of its kind.
david@zion:~/Projects/cheesy-gallery/spec/fixtures/test_site$ cat _site/galleries/first/index.html
This is a test gallery. The first of its kind.
david@zion:~/Projects/cheesy-gallery/spec/fixtures/test_site$
</code></pre></div></div>

<p>I’ve disabled layouting with the <code class="language-plaintext highlighter-rouge">x_</code> prefix there to avoid a lot of irrelevant HTML, but enabling it does do the right thing and applies the layout tree through Liquid.</p>

<p>Image data, of course, is passed through unmodified.</p>

<p>The <code class="language-plaintext highlighter-rouge">docs</code> attribute on the <code class="language-plaintext highlighter-rouge">Collection</code> contains all <code class="language-plaintext highlighter-rouge">Document</code> instances. There is one for the <code class="language-plaintext highlighter-rouge">first/index.html</code>, but none for the image-only directories. The <code class="language-plaintext highlighter-rouge">files</code> attribute contains all <code class="language-plaintext highlighter-rouge">StaticFile</code> instances.</p>

<p>Another annoying quirk is that <code class="language-plaintext highlighter-rouge">entries</code> is a flat array. The documentation explains how to iterate over that in Liquid.</p>

<p>The documentation enumerates a few other attributes a collection entry (i.e. <code class="language-plaintext highlighter-rouge">Document</code>) can have. None of them specifically useful to the nested gallery usecase.</p>

<p>In <a href="https://github.com/DavidS/cheesy-gallery/commit/d95692f21c25fb677b7748a350afca55e6dcd584">this commit</a> I implement all that I thought I had last weekend, but didn’t work, in a really nice and clean fashion:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def generate(site)
  @site = site
  collection = site.collections['galleries']

  # all galleries in the site
  galleries = Set[*collection.entries.map { |e| File.dirname(e) }]

  # all galleries with an index.html
  galleries_with_index = Set[*collection.entries.find_all { |e| e.end_with?('/index.html') }.map { |e| File.dirname(e) }]

  # fill in Documents for galleries that don't have an index.html
  (galleries - galleries_with_index).each do |e|
    doc = CheesyGallery::GalleryIndex.new(File.join('_galleries', e, 'index.html'), site: site, collection: collection)
    doc.read
    collection.docs &lt;&lt; doc if site.unpublished || doc.published?
  end

  files_by_dirname = {}
  collection.files.each { |e| (files_by_dirname[File.dirname(e.relative_path)] ||= []) &lt;&lt; e }

  collection.docs.each do |doc|
    # attach images
    doc.data['images'] = files_by_dirname[File.dirname(doc.relative_path)]
  end
end
</code></pre></div></div>

<p>First, <code class="language-plaintext highlighter-rouge">galleries</code> and <code class="language-plaintext highlighter-rouge">galleries_with_index</code> are calculated to be able to create new <code class="language-plaintext highlighter-rouge">CheesyGallery::GalleryIndex</code> instances for galleries that do not have a <code class="language-plaintext highlighter-rouge">index.html</code>. Then, the new Documents get created to fill in the blanks. Since jekyll maintains everything in flat lists, <code class="language-plaintext highlighter-rouge">files_by_dirname</code> is used to make the image linking easier. Finally, the <code class="language-plaintext highlighter-rouge">images</code> attribute is filled with all files belonging to a specific document.</p>

<p>In the <code class="language-plaintext highlighter-rouge">gallery.html</code>, I make some changes to show the images as an example how it can be used. For the next time I get around to this, I update the <a href="https://github.com/DavidS/cheesy-gallery/projects/1">project on github</a> with what I managed today and enhance the description of what to do next, as well as a couple of ideas for going forward.</p>

  </div><a class="u-url" href="/log/posts/2020-01-11-plans-of-mice-and-persons/index.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/log/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">DavidS&#39; log</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">David Schmitt</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
